---
layout: post
title: 打印服务器迁移中的问题
comments: true
categories: technology
---

# 第一次迁移失败

## 服务器性能指标
晚上修改了dns,在第二天白天应用服务直接挂了,多次进行尝试重启,发现服务无法启动,当时无法定位原因,只能先把dns切回到老
的服务器,在服务回复正常,找到原因,cup曲线图异常:在cup逐渐升高后在某个时间节点瞬间被压到10%,当时才明白服务器买的是
t5,t5服务器会在低cpu的情况下积攒积分,当cpu高于10%时,积分开始消耗,当积分消耗完毕时,cpu会被强制性的压到10%.这是
造成了本次迁移失败的原因,t5机器一般只会用于测试环境,切忌用于生产环境,风险非常高.

## eureka 服务心跳时间设置过段,将造成线程阻塞,导致cpu飙升.

# 第二次迁移失败

## 还是服务器性能问题
t5机器升级后,没有进行重启,导致机器还是t5...

# 第三次迁移失败
数据库通过阿里云的数据迁移完成,没有发生问题.
redis用写程序去跑,中间发生了问题,当时没有测试工具,没有在第一时间发现.
redis中的value是通过序列化对象后已字节存入redis,在redis迁移程序时读取了字符串,由于某些字节在utf-8
编码中不存在,导致读出的数据字节变化,写入目标库后造成脏数据.一个细节错误造成单据无法被反序列化,打印任务无法发送.
之前在写模板解析器的时候,曾经碰到过类似的问题,将字节指令转成字符串后,再次转后字节发送给打印机,发现打印出的内容有异常,
最后打印出前后的字节,仔细观察后,发现某些字节不一致,最后换成ISO-8859-1编码后才解决问题,这个地方之后要万分注意.

# 胜马服务器从两个节点变成一个节点发生的问题

在服务器减少节点后,白天用户大量反馈,打印机在线离线状态频繁,并且点击打印后,需要等一段时间打印机才会出单,当时取查看独苗节点
时,发现cpu和内存均在20%左右,直接确定服务器性能指标正常.于是进入服务器,进入docker容器查看打印日志,发现打印机一直在进行掉线
重连,而掉线的原因是因为心跳超过15s,超时导致.断定是因为线程变慢,而会导致线程大批量突然变慢的原因可能是硬件指标,查看了docker stats
,发现容器分配的内存爆满,当时才想到给容器只分配了1.5g的内存,因为之前在两个节点的情况下每台分配1.5g内存已足够,当从两个节点变成
一个节点的时候,以为2cpu4g的服务器够用,而忽略了容器分配的内存,这里以后也要万分注意.